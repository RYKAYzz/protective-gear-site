<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - ARK Hygiene Solutions</title>
    <link rel="stylesheet" href="style.css" />
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
      /* Clean Professional Black & White Admin Dashboard */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: #ffffff;
        color: #000000;
        line-height: 1.6;
      }

      .admin-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 40px 20px;
        min-height: 100vh;
        background: #ffffff;
      }

      .admin-header {
        background: #ffffff;
        padding: 30px;
        margin-bottom: 40px;
        border-bottom: 2px solid #000000;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
      }

      .admin-header h1 {
        margin: 0;
        color: #000000;
        font-size: 1.8rem;
        font-weight: 600;
        letter-spacing: -0.5px;
      }

      .admin-nav {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .admin-nav button {
        padding: 10px 20px;
        border: 1px solid #000000;
        background: #ffffff;
        color: #000000;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.2s;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: relative;
      }

      .admin-nav button:hover {
        background: #000000;
        color: #ffffff;
      }

      .admin-nav button.active {
        background: #000000;
        color: #ffffff;
      }

      /* Tooltip Styles */
      .admin-nav button::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        margin-bottom: 8px;
        padding: 6px 12px;
        background: #000000;
        color: #ffffff;
        font-size: 0.75rem;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
        text-transform: none;
        letter-spacing: 0;
        font-weight: 400;
        z-index: 1000;
      }

      .admin-nav button:hover::after {
        opacity: 1;
      }

      .login-section {
        max-width: 450px;
        margin: 120px auto;
        background: #ffffff;
        padding: 50px 40px;
        border: 2px solid #000000;
      }

      .login-section h2 {
        text-align: center;
        margin-bottom: 40px;
        color: #000000;
        font-size: 1.5rem;
        font-weight: 600;
        letter-spacing: -0.5px;
      }

      .form-group {
        margin-bottom: 25px;
      }

      .form-group label {
        display: block;
        font-size: 0.85rem;
        margin-bottom: 8px;
        color: #000000;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .form-group input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #000000;
        background: #ffffff;
        color: #000000;
        font-size: 1rem;
        transition: all 0.2s;
        box-sizing: border-box;
        font-family: inherit;
      }

      .form-group input:focus {
        outline: none;
        border-width: 2px;
      }

      .form-group input::placeholder {
        color: #666666;
      }

      .btn {
        width: 100%;
        padding: 14px;
        background: #000000;
        color: #ffffff;
        border: 2px solid #000000;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.2s;
      }

      .btn:hover {
        background: #ffffff;
        color: #000000;
      }

      .dashboard-section {
        display: none;
        background: #ffffff;
        padding: 0;
      }

      .dashboard-section.active {
        display: block;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 30px;
        margin-bottom: 50px;
      }

      .stat-card {
        background: #ffffff;
        padding: 30px;
        border: 2px solid #000000;
      }

      .stat-card h3 {
        margin: 0 0 15px 0;
        font-size: 0.75rem;
        color: #000000;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
      }

      .stat-card .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0;
        color: #000000;
        letter-spacing: -1px;
      }

      h2 {
        font-size: 1.5rem;
        font-weight: 600;
        color: #000000;
        margin-bottom: 30px;
        letter-spacing: -0.5px;
        border-bottom: 2px solid #000000;
        padding-bottom: 15px;
      }

      .table-container {
        overflow-x: auto;
        border: 2px solid #000000;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: #ffffff;
      }

      table th,
      table td {
        padding: 15px 20px;
        text-align: left;
        border-bottom: 1px solid #000000;
        font-size: 0.9rem;
      }

      table th {
        background: #000000;
        color: #ffffff;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 0.75rem;
      }

      table tr:last-child td {
        border-bottom: none;
      }

      table tr:hover {
        background: #f5f5f5;
      }

      table button {
        padding: 6px 16px;
        border: 1px solid #000000;
        background: #ffffff;
        color: #000000;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.2s;
      }

      table button:hover {
        background: #000000;
        color: #ffffff;
      }

      .badge {
        display: inline-block;
        padding: 4px 12px;
        border: 1px solid #000000;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .badge.new {
        background: #ffffff;
        color: #000000;
      }
      .badge.in-progress {
        background: #ffffff;
        color: #000000;
      }
      .badge.responded {
        background: #000000;
        color: #ffffff;
      }
      .badge.closed {
        background: #000000;
        color: #ffffff;
      }

      .badge.pending {
        background: #ffffff;
        color: #000000;
      }

      .badge.confirmed,
      .badge.processing,
      .badge.shipped,
      .badge.delivered {
        background: #000000;
        color: #ffffff;
      }

      .badge.cancelled {
        background: #ffffff;
        color: #000000;
        border: 1px dashed #000000;
      }

      .alert {
        padding: 15px 20px;
        margin-bottom: 20px;
        border: 2px solid #000000;
        font-size: 0.9rem;
        font-weight: 500;
      }

      .alert.success {
        background: #ffffff;
        color: #000000;
      }

      .alert.error {
        background: #000000;
        color: #ffffff;
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(3px);
      }

      .modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .modal-content {
        background: #ffffff;
        border: 2px solid #000000;
        max-width: 600px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        padding: 30px;
        position: relative;
      }

      .close-modal {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 24px;
        font-weight: 700;
        color: #000000;
        cursor: pointer;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #000000;
        transition: all 0.2s;
      }

      .close-modal:hover {
        background: #000000;
        color: #ffffff;
      }

      .modal-content h3 {
        margin: 0 0 25px 0;
        font-size: 1.5rem;
        font-weight: 600;
        color: #000000;
        border-bottom: 2px solid #000000;
        padding-bottom: 15px;
      }

      .form-group select {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #000000;
        background: #ffffff;
        color: #000000;
        font-size: 1rem;
        transition: all 0.2s;
        box-sizing: border-box;
        font-family: inherit;
      }

      .form-group select:focus {
        outline: none;
        border-width: 2px;
      }

      .form-group textarea {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #000000;
        background: #ffffff;
        color: #000000;
        font-size: 1rem;
        transition: all 0.2s;
        box-sizing: border-box;
        font-family: inherit;
        min-height: 120px;
        resize: vertical;
      }

      .form-group textarea:focus {
        outline: none;
        border-width: 2px;
      }

      .form-actions {
        display: flex;
        gap: 10px;
        margin-top: 25px;
      }

      .form-actions .btn {
        flex: 1;
        width: auto;
      }

      /* Custom Confirmation Modal */
      .confirmation-modal {
        display: none;
        position: fixed;
        z-index: 10001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .confirmation-modal.active {
        display: flex;
      }

      .confirmation-content {
        background: #ffffff;
        border: 3px solid #000000;
        max-width: 500px;
        width: 100%;
        padding: 40px;
        position: relative;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      }

      .confirmation-content h3 {
        margin: 0 0 20px 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: #000000;
        font-family: "Poppins", sans-serif;
        letter-spacing: -0.5px;
      }

      .confirmation-content p {
        margin: 0 0 30px 0;
        font-size: 1rem;
        color: #333333;
        line-height: 1.6;
        font-family: "Roboto", sans-serif;
        white-space: pre-line;
      }

      .confirmation-buttons {
        display: flex;
        gap: 15px;
        margin-top: 30px;
      }

      .confirmation-buttons button {
        flex: 1;
        padding: 14px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-family: "Roboto", sans-serif;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: 2px solid #000000;
      }

      .confirmation-buttons .btn-confirm {
        background: #000000;
        color: #ffffff;
      }

      .confirmation-buttons .btn-confirm:hover {
        background: #ffffff;
        color: #000000;
      }

      .confirmation-buttons .btn-cancel {
        background: #ffffff;
        color: #000000;
      }

      .confirmation-buttons .btn-cancel:hover {
        background: #000000;
        color: #ffffff;
      }

      /* Custom Prompt Modal */
      .prompt-modal {
        display: none;
        position: fixed;
        z-index: 10001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .prompt-modal.active {
        display: flex;
      }

      .prompt-content {
        background: #ffffff;
        border: 3px solid #000000;
        max-width: 500px;
        width: 100%;
        padding: 40px;
        position: relative;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      }

      .prompt-content h3 {
        margin: 0 0 20px 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: #000000;
        font-family: "Poppins", sans-serif;
        letter-spacing: -0.5px;
      }

      .prompt-content p {
        margin: 0 0 20px 0;
        font-size: 1rem;
        color: #333333;
        line-height: 1.6;
        font-family: "Roboto", sans-serif;
        white-space: pre-line;
      }

      .prompt-content input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #000000;
        background: #ffffff;
        color: #000000;
        font-size: 1rem;
        font-family: "Roboto", sans-serif;
        margin-bottom: 20px;
        box-sizing: border-box;
      }

      .prompt-content input:focus {
        outline: none;
        border-width: 3px;
      }

      .prompt-buttons {
        display: flex;
        gap: 15px;
        margin-top: 20px;
      }

      .prompt-buttons button {
        flex: 1;
        padding: 14px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-family: "Roboto", sans-serif;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: 2px solid #000000;
      }

      .prompt-buttons .btn-submit {
        background: #000000;
        color: #ffffff;
      }

      .prompt-buttons .btn-submit:hover {
        background: #ffffff;
        color: #000000;
      }

      .prompt-buttons .btn-cancel {
        background: #ffffff;
        color: #000000;
      }

      .prompt-buttons .btn-cancel:hover {
        background: #000000;
        color: #ffffff;
      }

      @media (max-width: 600px) {
        .confirmation-content,
        .prompt-content {
          padding: 30px 25px;
        }

        .confirmation-content h3,
        .prompt-content h3 {
          font-size: 1.3rem;
        }

        .confirmation-content p,
        .prompt-content p {
          font-size: 0.95rem;
        }
      }

      .btn-secondary {
        background: #ffffff;
        color: #000000;
        border: 2px solid #000000;
      }

      .btn-secondary:hover {
        background: #000000;
        color: #ffffff;
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #000000;
      }

      .empty-state p {
        margin: 10px 0;
        font-size: 1rem;
      }

      /* Action buttons */
      .action-buttons {
        display: flex;
        gap: 5px;
      }

      .action-buttons button {
        padding: 4px 12px;
        font-size: 0.75rem;
      }

      .view-btn {
        background: #ffffff;
        color: #000000;
        border: 1px solid #000000;
      }

      .view-btn:hover {
        background: #000000;
        color: #ffffff;
      }

      .delete-btn {
        background: #ffffff;
        color: #000000;
        border: 1px solid #000000;
      }

      .delete-btn:hover {
        background: #000000;
        color: #ffffff;
      }

      /* Inquiry/Order Detail View */
      .detail-view {
        display: none;
      }

      .detail-view.active {
        display: block;
      }

      .detail-section {
        margin-bottom: 25px;
        padding-bottom: 25px;
        border-bottom: 1px solid #000000;
      }

      .detail-section:last-child {
        border-bottom: none;
      }

      .detail-section h4 {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 15px;
        color: #000000;
        font-weight: 600;
      }

      .detail-row {
        display: grid;
        grid-template-columns: 150px 1fr;
        gap: 15px;
        margin-bottom: 12px;
        padding: 8px 0;
        border-bottom: 1px solid #e0e0e0;
      }

      .detail-row:last-child {
        border-bottom: none;
      }

      .detail-label {
        font-weight: 600;
        color: #000000;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 0.5px;
      }

      .detail-value {
        color: #000000;
      }

      @media (max-width: 768px) {
        .admin-container {
          padding: 20px 15px;
        }

        .admin-header {
          padding: 20px;
          flex-direction: column;
          align-items: flex-start;
          gap: 20px;
        }

        .admin-header h1 {
          font-size: 1.5rem;
        }

        .admin-nav {
          width: 100%;
          gap: 5px;
        }

        .admin-nav button {
          flex: 1;
          padding: 10px 12px;
          font-size: 0.8rem;
        }

        .stats-grid {
          grid-template-columns: 1fr;
          gap: 20px;
        }

        .login-section {
          margin: 60px auto;
          padding: 30px 25px;
        }

        table {
          font-size: 0.8rem;
        }

        table th,
        table td {
          padding: 10px 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="admin-container">
      <!-- Login Section -->
      <div id="loginSection" class="login-section">
        <h2>Admin Login</h2>
        <form id="loginForm">
          <div class="form-group">
            <label for="email">Email</label>
            <input
              type="email"
              id="email"
              name="email"
              autocomplete="email"
              required
            />
          </div>
          <div class="form-group">
            <label for="password">Password</label>
            <input
              type="password"
              id="password"
              name="password"
              autocomplete="current-password"
              required
            />
          </div>
          <button type="submit" class="btn">Login</button>
        </form>
        <div id="loginError" style="display: none" class="alert error"></div>
      </div>

      <!-- Custom Confirmation Modal -->
      <div id="confirmationModal" class="confirmation-modal">
        <div class="confirmation-content">
          <h3 id="confirmationTitle"></h3>
          <p id="confirmationMessage"></p>
          <div class="confirmation-buttons">
            <button class="btn-confirm" id="confirmationConfirm">
              Confirm
            </button>
            <button class="btn-cancel" id="confirmationCancel">Cancel</button>
          </div>
        </div>
      </div>

      <!-- Custom Prompt Modal -->
      <div id="promptModal" class="prompt-modal">
        <div class="prompt-content">
          <h3 id="promptTitle"></h3>
          <p id="promptMessage"></p>
          <input
            type="text"
            id="promptInput"
            placeholder="Type here..."
            autocomplete="off"
          />
          <div class="prompt-buttons">
            <button class="btn-submit" id="promptSubmit">Submit</button>
            <button class="btn-cancel" id="promptCancel">Cancel</button>
          </div>
        </div>
      </div>

      <!-- Dashboard Section -->
      <div id="dashboardSection" style="display: none">
        <div class="admin-header">
          <h1>ARK Hygiene Admin Dashboard</h1>
          <div class="admin-nav">
            <button
              onclick="showSection('dashboard')"
              class="active"
              data-tooltip="View overview statistics and key metrics"
            >
              Dashboard
            </button>
            <button
              onclick="showSection('products')"
              data-tooltip="Manage product catalog - add, edit, or delete products"
            >
              Products
            </button>
            <button
              onclick="showSection('inquiries')"
              data-tooltip="View and respond to customer quote requests and inquiries from contact forms"
            >
              Quote Requests
            </button>
            <!-- Orders section hidden - currently all customer requests go to Quote Requests -->
            <!-- <button
              onclick="showSection('orders')"
              data-tooltip="Track and manage confirmed customer orders"
            >
              Orders
            </button> -->
            <button
              onclick="showSection('datamanagement')"
              data-tooltip="Download data and manage database storage to prevent exceeding limits"
            >
              Data Management
            </button>
            <button
              onclick="logout()"
              data-tooltip="Log out from admin dashboard"
            >
              Logout
            </button>
          </div>
        </div>

        <!-- Dashboard Stats -->
        <div id="dashboard" class="dashboard-section active">
          <h2>Overview</h2>
          <div class="stats-grid" id="statsGrid">
            <div
              class="stat-card"
              title="Total number of products in your catalog"
            >
              <h3>Total Products</h3>
              <p class="stat-value" id="totalProducts">0</p>
            </div>
            <div
              class="stat-card"
              title="Products currently visible on the website"
            >
              <h3>Active Products</h3>
              <p class="stat-value" id="activeProducts">0</p>
            </div>
            <div
              class="stat-card"
              title="New quote requests from customers waiting for response"
            >
              <h3>New Quote Requests</h3>
              <p class="stat-value" id="newInquiries">0</p>
            </div>
            <div
              class="stat-card"
              title="Pending orders (if any confirmed orders exist)"
            >
              <h3>Pending Orders</h3>
              <p class="stat-value" id="pendingOrders">0</p>
            </div>
          </div>

          <!-- Recent Activity -->
          <div style="margin-top: 50px">
            <h2>Recent Activity</h2>
            <div
              style="
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 30px;
                margin-top: 30px;
              "
            >
              <div>
                <h4
                  style="
                    font-size: 0.85rem;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                    margin-bottom: 20px;
                    padding-bottom: 10px;
                    border-bottom: 2px solid #000000;
                  "
                >
                  Recent Inquiries
                </h4>
                <div
                  id="recentInquiriesList"
                  class="table-container"
                  style="max-height: 300px; overflow-y: auto"
                >
                  <!-- Recent inquiries will be loaded here -->
                </div>
              </div>
              <div>
                <h4
                  style="
                    font-size: 0.85rem;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                    margin-bottom: 20px;
                    padding-bottom: 10px;
                    border-bottom: 2px solid #000000;
                  "
                >
                  Recent Orders
                </h4>
                <div
                  id="recentOrdersList"
                  class="table-container"
                  style="max-height: 300px; overflow-y: auto"
                >
                  <!-- Recent orders will be loaded here -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Products Section -->
        <div id="products" class="dashboard-section">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 30px;
            "
          >
            <h2 style="margin: 0">Products</h2>
            <button
              onclick="openProductModal()"
              class="btn"
              style="width: auto; padding: 10px 20px"
            >
              + Add Product
            </button>
          </div>
          <div class="table-container">
            <table id="productsTable">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Category</th>
                  <th>Price</th>
                  <th>Stock</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="productsTableBody">
                <!-- Products will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Data Management Section -->
        <div id="datamanagement" class="dashboard-section">
          <h2>Data Management</h2>

          <!-- Database Usage Warning -->
          <div
            id="dbUsageWarning"
            class="alert error"
            style="display: none; margin-bottom: 30px"
          >
            <strong>Warning:</strong> Your database is approaching the 512MB
            limit. Consider deleting old data to free up space.
          </div>

          <!-- Database Statistics -->
          <div class="stats-grid" style="margin-bottom: 40px">
            <div class="stat-card">
              <h3>Database Usage</h3>
              <p class="stat-value" id="dbUsage">Calculating...</p>
              <p style="font-size: 0.75rem; margin-top: 10px; color: #666">
                Estimated size (512MB limit)
              </p>
            </div>
            <div class="stat-card">
              <h3>Total Records</h3>
              <p class="stat-value" id="totalRecords">0</p>
              <p style="font-size: 0.75rem; margin-top: 10px; color: #666">
                Quote Requests + Orders + Products
              </p>
            </div>
            <div class="stat-card">
              <h3>Quote Requests</h3>
              <p class="stat-value" id="inquiriesCount">0</p>
            </div>
            <div class="stat-card">
              <h3>Orders Count</h3>
              <p class="stat-value" id="ordersCount">0</p>
            </div>
          </div>

          <!-- Download Data Section -->
          <div
            style="
              margin-bottom: 40px;
              padding: 30px;
              border: 2px solid #000000;
            "
          >
            <h3
              style="
                margin-bottom: 20px;
                font-size: 1.2rem;
                border-bottom: 1px solid #000000;
                padding-bottom: 10px;
              "
            >
              Download Data Backup
            </h3>
            <p style="margin-bottom: 20px; font-size: 0.9rem; color: #666">
              Export your data as CSV or JSON files before deleting to keep
              backups.
            </p>
            <div style="display: flex; gap: 15px; flex-wrap: wrap">
              <button
                onclick="downloadData('inquiries', 'csv')"
                class="btn"
                style="width: auto; padding: 12px 24px"
              >
                Download Quote Requests (CSV)
              </button>
              <button
                onclick="downloadData('inquiries', 'pdf')"
                class="btn"
                style="width: auto; padding: 12px 24px"
              >
                Download Quote Requests (PDF)
              </button>
              <button
                onclick="downloadData('orders', 'csv')"
                class="btn"
                style="width: auto; padding: 12px 24px"
              >
                Download Orders (CSV)
              </button>
              <button
                onclick="downloadData('orders', 'pdf')"
                class="btn"
                style="width: auto; padding: 12px 24px"
              >
                Download Orders (PDF)
              </button>
              <button
                onclick="downloadData('products', 'csv')"
                class="btn"
                style="width: auto; padding: 12px 24px"
              >
                Download Products (CSV)
              </button>
              <button
                onclick="downloadData('products', 'pdf')"
                class="btn"
                style="width: auto; padding: 12px 24px"
              >
                Download Products (PDF)
              </button>
            </div>
          </div>

          <!-- Delete Data Section -->
          <div
            style="
              padding: 30px;
              border: 2px solid #000000;
              background: #f9f9f9;
            "
          >
            <h3
              style="
                margin-bottom: 20px;
                font-size: 1.2rem;
                border-bottom: 1px solid #000000;
                padding-bottom: 10px;
              "
            >
              Delete Old Data
            </h3>
            <p style="margin-bottom: 20px; font-size: 0.9rem; color: #666">
              <strong>Warning:</strong> This action cannot be undone. Please
              download backups first.
            </p>

            <!-- Delete Inquiries -->
            <div
              style="
                margin-bottom: 30px;
                padding: 20px;
                border: 1px solid #000000;
                background: #ffffff;
              "
            >
              <h4
                style="margin-bottom: 15px; font-size: 1rem; font-weight: 600"
              >
                Delete Quote Requests
              </h4>
              <div
                style="
                  display: flex;
                  gap: 15px;
                  flex-wrap: wrap;
                  align-items: flex-end;
                "
              >
                <div class="form-group" style="flex: 1; min-width: 200px">
                  <label for="inquiryDeleteDate">Older than (days)</label>
                  <input
                    type="number"
                    id="inquiryDeleteDate"
                    value="90"
                    min="1"
                    style="
                      width: 100%;
                      padding: 10px;
                      border: 1px solid #000000;
                    "
                  />
                </div>
                <div class="form-group" style="flex: 1; min-width: 200px">
                  <label for="inquiryDeleteStatus">Status</label>
                  <select
                    id="inquiryDeleteStatus"
                    style="
                      width: 100%;
                      padding: 10px;
                      border: 1px solid #000000;
                    "
                  >
                    <option value="all">All Statuses</option>
                    <option value="closed">Closed Only</option>
                    <option value="responded">Responded Only</option>
                    <option value="closed,responded">Closed & Responded</option>
                  </select>
                </div>
                <button
                  onclick="deleteInquiriesBulk()"
                  class="btn"
                  style="
                    width: auto;
                    padding: 12px 24px;
                    background: #000000;
                    color: #ffffff;
                    border: 2px solid #000000;
                  "
                >
                  Delete Quote Requests
                </button>
              </div>
            </div>

            <!-- Delete Orders -->
            <div
              style="
                margin-bottom: 30px;
                padding: 20px;
                border: 1px solid #000000;
                background: #ffffff;
              "
            >
              <h4
                style="margin-bottom: 15px; font-size: 1rem; font-weight: 600"
              >
                Delete Orders
              </h4>
              <div
                style="
                  display: flex;
                  gap: 15px;
                  flex-wrap: wrap;
                  align-items: flex-end;
                "
              >
                <div class="form-group" style="flex: 1; min-width: 200px">
                  <label for="orderDeleteDate">Older than (days)</label>
                  <input
                    type="number"
                    id="orderDeleteDate"
                    value="180"
                    min="1"
                    style="
                      width: 100%;
                      padding: 10px;
                      border: 1px solid #000000;
                    "
                  />
                </div>
                <div class="form-group" style="flex: 1; min-width: 200px">
                  <label for="orderDeleteStatus">Status</label>
                  <select
                    id="orderDeleteStatus"
                    style="
                      width: 100%;
                      padding: 10px;
                      border: 1px solid #000000;
                    "
                  >
                    <option value="all">All Statuses</option>
                    <option value="delivered">Delivered Only</option>
                    <option value="cancelled">Cancelled Only</option>
                    <option value="delivered,cancelled">
                      Delivered & Cancelled
                    </option>
                  </select>
                </div>
                <button
                  onclick="deleteOrdersBulk()"
                  class="btn"
                  style="
                    width: auto;
                    padding: 12px 24px;
                    background: #000000;
                    color: #ffffff;
                    border: 2px solid #000000;
                  "
                >
                  Delete Orders
                </button>
              </div>
            </div>

            <!-- Clear All Data (Danger Zone) -->
            <div
              style="
                margin-top: 40px;
                padding: 30px;
                border: 3px solid #000000;
                background: #fff5f5;
              "
            >
              <h3
                style="
                  margin-bottom: 20px;
                  font-size: 1.3rem;
                  font-weight: 700;
                  color: #000000;
                  border-bottom: 2px solid #000000;
                  padding-bottom: 10px;
                "
              >
                Clear All Data (Danger Zone)
              </h3>
              <p
                style="
                  margin-bottom: 25px;
                  font-size: 0.95rem;
                  color: #000000;
                  font-weight: 600;
                  line-height: 1.6;
                "
              >
                <strong>WARNING:</strong> This will permanently delete ALL data
                from the database (Quote Requests, Orders, and Products). This
                action cannot be undone and will reset the database to 0 MB.
              </p>
              <div
                style="
                  background: #ffffff;
                  padding: 20px;
                  border: 2px solid #000000;
                  margin-bottom: 20px;
                "
              >
                <h4
                  style="margin-bottom: 15px; font-size: 1rem; font-weight: 600"
                >
                  Before Clearing - Download Your Data First:
                </h4>
                <div
                  style="
                    display: flex;
                    gap: 10px;
                    flex-wrap: wrap;
                    margin-bottom: 15px;
                  "
                >
                  <button
                    onclick="downloadData('inquiries', 'pdf')"
                    class="btn"
                    style="
                      width: auto;
                      padding: 10px 20px;
                      font-size: 0.85rem;
                      background: #000000;
                      color: #ffffff;
                    "
                  >
                    Download Quote Requests (PDF)
                  </button>
                  <button
                    onclick="downloadData('orders', 'pdf')"
                    class="btn"
                    style="
                      width: auto;
                      padding: 10px 20px;
                      font-size: 0.85rem;
                      background: #000000;
                      color: #ffffff;
                    "
                  >
                    Download Orders (PDF)
                  </button>
                  <button
                    onclick="downloadData('products', 'csv')"
                    class="btn"
                    style="
                      width: auto;
                      padding: 10px 20px;
                      font-size: 0.85rem;
                      background: #000000;
                      color: #ffffff;
                    "
                  >
                    Download Products (CSV)
                  </button>
                </div>
                <p style="font-size: 0.85rem; color: #666; margin: 0">
                  Make sure you have downloaded all your data before proceeding.
                </p>
              </div>
              <button
                onclick="clearAllData()"
                class="btn"
                style="
                  width: 100%;
                  padding: 15px;
                  background: #000000;
                  color: #ffffff;
                  border: 3px solid #000000;
                  font-size: 1.1rem;
                  font-weight: 700;
                  text-transform: uppercase;
                  letter-spacing: 1px;
                "
              >
                CLEAR ALL DATABASE DATA
              </button>
            </div>
          </div>
        </div>

        <!-- Quote Requests Section (Inquiries) -->
        <div id="inquiries" class="dashboard-section">
          <h2>Quote Requests</h2>
          <p style="margin-bottom: 20px; font-size: 0.9rem; color: #666">
            All customer quote requests and contact messages appear here.
            Respond via email using the email link.
          </p>
          <div class="table-container">
            <table id="inquiriesTable">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Subject</th>
                  <th>Status</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="inquiriesTableBody">
                <!-- Inquiries will be loaded here -->
              </tbody>
            </table>
          </div>

          <!-- Inquiry Detail Modal -->
          <div id="inquiryDetailModal" class="modal">
            <div class="modal-content">
              <span
                class="close-modal"
                onclick="closeModal('inquiryDetailModal')"
                >&times;</span
              >
              <h3>Inquiry Details</h3>
              <div id="inquiryDetailContent"></div>
              <div class="form-actions">
                <button
                  onclick="closeModal('inquiryDetailModal')"
                  class="btn btn-secondary"
                >
                  Close
                </button>
                <button onclick="updateInquiryStatus()" class="btn">
                  Update Status
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Orders Section -->
        <div id="orders" class="dashboard-section">
          <h2>Orders</h2>
          <div class="table-container">
            <table id="ordersTable">
              <thead>
                <tr>
                  <th>Order #</th>
                  <th>Customer</th>
                  <th>Total</th>
                  <th>Status</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="ordersTableBody">
                <!-- Orders will be loaded here -->
              </tbody>
            </table>
          </div>

          <!-- Order Detail Modal -->
          <div id="orderDetailModal" class="modal">
            <div class="modal-content">
              <span class="close-modal" onclick="closeModal('orderDetailModal')"
                >&times;</span
              >
              <h3>Order Details</h3>
              <div id="orderDetailContent"></div>
              <div class="form-actions">
                <button
                  onclick="closeModal('orderDetailModal')"
                  class="btn btn-secondary"
                >
                  Close
                </button>
                <button onclick="updateOrderStatus()" class="btn">
                  Update Status
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Product Modal (Add/Edit) -->
    <div id="productModal" class="modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeModal('productModal')"
          >&times;</span
        >
        <h3 id="productModalTitle">Add Product</h3>
        <form id="productForm">
          <input type="hidden" id="productId" name="id" />

          <div class="form-group">
            <label for="productName">Product Name *</label>
            <input
              type="text"
              id="productName"
              name="name"
              required
              placeholder="Enter product name"
            />
          </div>

          <div class="form-group">
            <label for="productDescription">Description *</label>
            <textarea
              id="productDescription"
              name="description"
              required
              placeholder="Enter product description"
            ></textarea>
          </div>

          <div class="form-group">
            <label for="productCategory">Category *</label>
            <select id="productCategory" name="category" required>
              <option value="">Select category</option>
              <option value="ppe-safety-gear">PPE & Safety Gear</option>
              <option value="medical-equipment">Medical Equipment</option>
              <option value="sterilization-waste">
                Sterilization & Waste Equipment
              </option>
              <option value="sanitary-solutions">Sanitary Solutions</option>
              <option value="spill-management">Spill Management</option>
              <option value="public-health-sanitation">
                Public Health & Sanitation
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="productSubcategory">Subcategory</label>
            <input
              type="text"
              id="productSubcategory"
              name="subcategory"
              placeholder="Optional subcategory"
            />
          </div>

          <div class="form-group">
            <label for="productImage">Image URL *</label>
            <input
              type="text"
              id="productImage"
              name="image"
              required
              placeholder="e.g., assets/PPE-safety-gear/face-shield.png"
            />
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px">
            <div class="form-group">
              <label for="productPrice">Price (KES)</label>
              <input
                type="number"
                id="productPrice"
                name="price"
                min="0"
                step="0.01"
                placeholder="0.00"
              />
            </div>

            <div class="form-group">
              <label for="productStock">Stock Quantity</label>
              <input
                type="number"
                id="productStock"
                name="stock"
                min="0"
                placeholder="0"
              />
            </div>
          </div>

          <div style="display: flex; gap: 20px; margin-top: 10px">
            <label
              style="
                display: flex;
                align-items: center;
                gap: 8px;
                cursor: pointer;
              "
            >
              <input type="checkbox" id="productActive" name="active" checked />
              <span style="font-size: 0.9rem">Active (visible on website)</span>
            </label>
            <label
              style="
                display: flex;
                align-items: center;
                gap: 8px;
                cursor: pointer;
              "
            >
              <input type="checkbox" id="productFeatured" name="featured" />
              <span style="font-size: 0.9rem">Featured</span>
            </label>
          </div>

          <div class="form-actions">
            <button
              type="button"
              onclick="closeModal('productModal')"
              class="btn btn-secondary"
            >
              Cancel
            </button>
            <button type="submit" class="btn">Save Product</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Inquiry Status Update Modal -->
    <div id="inquiryStatusModal" class="modal">
      <div class="modal-content" style="max-width: 400px">
        <span class="close-modal" onclick="closeModal('inquiryStatusModal')"
          >&times;</span
        >
        <h3>Update Inquiry Status</h3>
        <div class="form-group">
          <label for="inquiryStatusSelect">Status *</label>
          <select id="inquiryStatusSelect" required>
            <option value="new">New</option>
            <option value="in-progress">In Progress</option>
            <option value="responded">Responded</option>
            <option value="closed">Closed</option>
          </select>
        </div>
        <div class="form-group">
          <label for="inquiryResponse">Response Notes</label>
          <textarea
            id="inquiryResponse"
            placeholder="Add response notes or comments..."
          ></textarea>
        </div>
        <div class="form-actions">
          <button
            onclick="closeModal('inquiryStatusModal')"
            class="btn btn-secondary"
          >
            Cancel
          </button>
          <button onclick="saveInquiryStatus()" class="btn">Update</button>
        </div>
      </div>
    </div>

    <!-- Order Status Update Modal -->
    <div id="orderStatusModal" class="modal">
      <div class="modal-content" style="max-width: 400px">
        <span class="close-modal" onclick="closeModal('orderStatusModal')"
          >&times;</span
        >
        <h3>Update Order Status</h3>
        <div class="form-group">
          <label for="orderStatusSelect">Status *</label>
          <select id="orderStatusSelect" required>
            <option value="pending">Pending</option>
            <option value="confirmed">Confirmed</option>
            <option value="processing">Processing</option>
            <option value="shipped">Shipped</option>
            <option value="delivered">Delivered</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
        <div class="form-group">
          <label for="orderPaymentStatus">Payment Status</label>
          <select id="orderPaymentStatus">
            <option value="pending">Pending</option>
            <option value="paid">Paid</option>
            <option value="failed">Failed</option>
            <option value="refunded">Refunded</option>
          </select>
        </div>
        <div class="form-group">
          <label for="orderTracking">Tracking Number</label>
          <input
            type="text"
            id="orderTracking"
            placeholder="Enter tracking number"
          />
        </div>
        <div class="form-actions">
          <button
            onclick="closeModal('orderStatusModal')"
            class="btn btn-secondary"
          >
            Cancel
          </button>
          <button onclick="saveOrderStatus()" class="btn">Update</button>
        </div>
      </div>
    </div>

    <script src="js/api.js"></script>
    <script>
      // Global functions accessible from onclick handlers
      function showDashboard() {
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("dashboardSection").style.display = "block";
        loadDashboardData();
      }

      function logout() {
        api.logout();
        document.getElementById("loginSection").style.display = "block";
        document.getElementById("dashboardSection").style.display = "none";
      }

      function showSection(sectionName) {
        // Hide all sections
        document.querySelectorAll(".dashboard-section").forEach((section) => {
          section.classList.remove("active");
        });

        // Show selected section
        const section = document.getElementById(sectionName);
        if (section) {
          section.classList.add("active");
        }

        // Update active button
        document.querySelectorAll(".admin-nav button").forEach((btn) => {
          btn.classList.remove("active");
        });
        if (event && event.target) {
          event.target.classList.add("active");
        }

        // Load section data
        if (sectionName === "dashboard") {
          loadDashboardData();
        } else if (sectionName === "products") {
          loadProducts();
        } else if (sectionName === "inquiries") {
          loadInquiries();
        } else if (sectionName === "orders") {
          loadOrders();
        } else if (sectionName === "datamanagement") {
          loadDataManagement();
        }
      }

      // Product Management
      let currentEditingProductId = null;
      let currentEditingInquiryId = null;
      let currentEditingOrderId = null;

      function openProductModal(productId = null) {
        currentEditingProductId = productId;
        const modal = document.getElementById("productModal");
        const form = document.getElementById("productForm");
        const title = document.getElementById("productModalTitle");

        if (productId) {
          title.textContent = "Edit Product";
          loadProductForEdit(productId);
        } else {
          title.textContent = "Add Product";
          form.reset();
          document.getElementById("productId").value = "";
          document.getElementById("productActive").checked = true;
          document.getElementById("productFeatured").checked = false;
        }

        modal.classList.add("active");
      }

      async function loadProductForEdit(id) {
        try {
          const response = await api.getProduct(id);
          if (response.success && response.data) {
            const product = response.data;
            document.getElementById("productId").value = product._id;
            document.getElementById("productName").value = product.name || "";
            document.getElementById("productDescription").value =
              product.description || "";
            document.getElementById("productCategory").value =
              product.category || "";
            document.getElementById("productSubcategory").value =
              product.subcategory || "";
            document.getElementById("productImage").value = product.image || "";
            document.getElementById("productPrice").value = product.price || "";
            document.getElementById("productStock").value = product.stock || 0;
            document.getElementById("productActive").checked =
              product.active !== false;
            document.getElementById("productFeatured").checked =
              product.featured === true;
          }
        } catch (error) {
          console.error("Error loading product:", error);
          showNotification("Error loading product", "error");
        }
      }

      document
        .getElementById("productForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = {
            name: document.getElementById("productName").value,
            description: document.getElementById("productDescription").value,
            category: document.getElementById("productCategory").value,
            subcategory: document.getElementById("productSubcategory").value,
            image: document.getElementById("productImage").value,
            price:
              parseFloat(document.getElementById("productPrice").value) || 0,
            stock: parseInt(document.getElementById("productStock").value) || 0,
            active: document.getElementById("productActive").checked,
            featured: document.getElementById("productFeatured").checked,
          };

          try {
            let response;
            if (currentEditingProductId) {
              response = await api.updateProduct(
                currentEditingProductId,
                formData
              );
            } else {
              response = await api.createProduct(formData);
            }

            if (response.success) {
              showNotification(
                `Product ${
                  currentEditingProductId ? "updated" : "created"
                } successfully`,
                "success"
              );
              closeModal("productModal");
              loadProducts();
              loadDashboardData();
            } else {
              showNotification(
                response.message || "Error saving product",
                "error"
              );
            }
          } catch (error) {
            console.error("Error saving product:", error);
            showNotification("Error saving product: " + error.message, "error");
          }
        });

      function editProduct(id) {
        openProductModal(id);
      }

      async function deleteProduct(id) {
        if (!confirm("Are you sure you want to delete this product?")) {
          return;
        }

        try {
          const response = await api.deleteProduct(id);
          if (response.success) {
            showNotification("Product deleted successfully", "success");
            loadProducts();
            loadDashboardData();
          } else {
            showNotification(
              response.message || "Error deleting product",
              "error"
            );
          }
        } catch (error) {
          console.error("Error deleting product:", error);
          showNotification("Error deleting product", "error");
        }
      }

      // Inquiry Management
      async function viewInquiry(id) {
        currentEditingInquiryId = id;
        try {
          const response = await api.getInquiry(id);
          if (response.success && response.data) {
            const inquiry = response.data;
            const content = document.getElementById("inquiryDetailContent");

            content.innerHTML = `
              <div class="detail-section">
                <h4>Customer Information</h4>
                <div class="detail-row">
                  <span class="detail-label">Name:</span>
                  <span class="detail-value">${inquiry.name}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Email:</span>
                  <span class="detail-value"><a href="javascript:void(0)" onclick="openEmailClient('${escapeForOnClick(
                    inquiry.email
                  )}', '${escapeForOnClick(
              inquiry.subject || "Re: Your Inquiry"
            )}', '${escapeForOnClick(
              (inquiry.message || "").substring(0, 500)
            )}')" style="color: #000; text-decoration: underline; cursor: pointer;" title="Click to respond via email">${
              inquiry.email
            }</a></span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Phone:</span>
                  <span class="detail-value">${
                    inquiry.phone || "Not provided"
                  }</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Company:</span>
                  <span class="detail-value">${
                    inquiry.company || "Not provided"
                  }</span>
                </div>
              </div>
              <div class="detail-section">
                <h4>Inquiry Details</h4>
                <div class="detail-row">
                  <span class="detail-label">Subject:</span>
                  <span class="detail-value">${inquiry.subject}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Status:</span>
                  <span class="detail-value"><span class="badge ${
                    inquiry.status
                  }">${inquiry.status}</span></span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Date:</span>
                  <span class="detail-value">${new Date(
                    inquiry.createdAt
                  ).toLocaleString()}</span>
                </div>
                ${
                  inquiry.productCategory
                    ? `
                <div class="detail-row">
                  <span class="detail-label">Category:</span>
                  <span class="detail-value">${inquiry.productCategory}</span>
                </div>
                `
                    : ""
                }
                ${
                  inquiry.quantity
                    ? `
                <div class="detail-row">
                  <span class="detail-label">Quantity:</span>
                  <span class="detail-value">${inquiry.quantity}</span>
                </div>
                `
                    : ""
                }
                <div class="detail-row" style="grid-template-columns: 1fr;">
                  <div>
                    <span class="detail-label">Message:</span>
                    <div class="detail-value" style="margin-top: 12px; padding: 16px; background: #f9f9f9; border: 1px solid #000000; font-family: 'Courier New', monospace; font-size: 0.9rem; line-height: 1.8; white-space: pre-wrap; word-wrap: break-word; max-height: 400px; overflow-y: auto;">${formatMessage(
                      inquiry.message || ""
                    )}</div>
                  </div>
                </div>
                ${
                  inquiry.response
                    ? `
                <div class="detail-row" style="grid-template-columns: 1fr;">
                  <div>
                    <span class="detail-label">Response Notes:</span>
                    <div class="detail-value" style="margin-top: 12px; padding: 16px; background: #f9f9f9; border: 1px solid #000000; font-family: 'Courier New', monospace; font-size: 0.9rem; line-height: 1.8; white-space: pre-wrap; word-wrap: break-word; max-height: 300px; overflow-y: auto;">${formatMessage(
                      inquiry.response || ""
                    )}</div>
                  </div>
                </div>
                `
                    : ""
                }
              </div>
            `;

            // Set current status in modal
            document.getElementById("inquiryStatusSelect").value =
              inquiry.status || "new";
            document.getElementById("inquiryResponse").value =
              inquiry.response || "";

            const modal = document.getElementById("inquiryDetailModal");
            modal.classList.add("active");
          }
        } catch (error) {
          console.error("Error loading inquiry:", error);
          showNotification("Error loading inquiry", "error");
        }
      }

      function updateInquiryStatus() {
        closeModal("inquiryDetailModal");
        const modal = document.getElementById("inquiryStatusModal");
        modal.classList.add("active");
      }

      async function saveInquiryStatus() {
        if (!currentEditingInquiryId) return;

        const status = document.getElementById("inquiryStatusSelect").value;
        const response = document.getElementById("inquiryResponse").value;

        try {
          const updateData = { status };
          if (response) {
            updateData.response = response;
          }

          const result = await api.updateInquiry(
            currentEditingInquiryId,
            updateData
          );
          if (result.success) {
            showNotification("Inquiry updated successfully", "success");
            closeModal("inquiryStatusModal");
            loadInquiries();
            loadDashboardData();
          } else {
            showNotification(
              result.message || "Error updating inquiry",
              "error"
            );
          }
        } catch (error) {
          console.error("Error updating inquiry:", error);
          showNotification("Error updating inquiry", "error");
        }
      }

      async function deleteInquiry(id) {
        if (!confirm("Are you sure you want to delete this inquiry?")) {
          return;
        }

        try {
          const response = await api.deleteInquiry(id);
          if (response.success) {
            showNotification("Inquiry deleted successfully", "success");
            loadInquiries();
            loadDashboardData();
          }
        } catch (error) {
          console.error("Error deleting inquiry:", error);
          showNotification("Error deleting inquiry", "error");
        }
      }

      // Order Management
      async function viewOrder(id) {
        currentEditingOrderId = id;
        try {
          const response = await api.getOrder(id);
          if (response.success && response.data) {
            const order = response.data;
            const content = document.getElementById("orderDetailContent");

            content.innerHTML = `
              <div class="detail-section">
                <h4>Order Information</h4>
                <div class="detail-row">
                  <span class="detail-label">Order #:</span>
                  <span class="detail-value">${order.orderNumber}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Status:</span>
                  <span class="detail-value"><span class="badge ${
                    order.status
                  }">${order.status}</span></span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Payment:</span>
                  <span class="detail-value"><span class="badge ${
                    order.paymentStatus
                  }">${order.paymentStatus}</span></span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Date:</span>
                  <span class="detail-value">${new Date(
                    order.createdAt
                  ).toLocaleString()}</span>
                </div>
              </div>
              <div class="detail-section">
                <h4>Customer Information</h4>
                <div class="detail-row">
                  <span class="detail-label">Name:</span>
                  <span class="detail-value">${order.customer.name}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Email:</span>
                  <span class="detail-value"><a href="javascript:void(0)" onclick="openEmailClient('${escapeForOnClick(
                    order.customer.email
                  )}', '${escapeForOnClick(
              "Re: Your Order " + (order.orderNumber || "")
            )}', '${escapeForOnClick(
              "Hello " + order.customer.name + ",\\n\\nRegarding your order..."
            )}')" style="color: #000; text-decoration: underline; cursor: pointer;" title="Click to respond via email">${
              order.customer.email
            }</a></span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Phone:</span>
                  <span class="detail-value">${order.customer.phone}</span>
                </div>
                ${
                  order.customer.company
                    ? `
                <div class="detail-row">
                  <span class="detail-label">Company:</span>
                  <span class="detail-value">${order.customer.company}</span>
                </div>
                `
                    : ""
                }
                ${
                  order.customer.address
                    ? `
                <div class="detail-row" style="grid-template-columns: 1fr;">
                  <div>
                    <span class="detail-label">Address:</span>
                    <p class="detail-value" style="margin-top: 8px;">
                      ${order.customer.address.street || ""}<br>
                      ${order.customer.address.city || ""}<br>
                      ${order.customer.address.postalCode || ""}<br>
                      ${order.customer.address.country || "Kenya"}
                    </p>
                  </div>
                </div>
                `
                    : ""
                }
              </div>
              <div class="detail-section">
                <h4>Order Items</h4>
                <div class="table-container" style="margin-top: 15px;">
                  <table style="font-size: 0.85rem;">
                    <thead>
                      <tr>
                        <th>Item</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>Total</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${order.items
                        .map(
                          (item) => `
                        <tr>
                          <td>${item.name}</td>
                          <td>${item.quantity}</td>
                          <td>KES ${item.price.toFixed(2)}</td>
                          <td>KES ${item.total.toFixed(2)}</td>
                        </tr>
                      `
                        )
                        .join("")}
                      <tr style="border-top: 2px solid #000000; font-weight: 600;">
                        <td colspan="3">Total</td>
                        <td>KES ${order.total.toFixed(2)}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            `;

            // Set current values in status modal
            document.getElementById("orderStatusSelect").value =
              order.status || "pending";
            document.getElementById("orderPaymentStatus").value =
              order.paymentStatus || "pending";
            document.getElementById("orderTracking").value =
              order.trackingNumber || "";

            const modal = document.getElementById("orderDetailModal");
            modal.classList.add("active");
          }
        } catch (error) {
          console.error("Error loading order:", error);
          showNotification("Error loading order", "error");
        }
      }

      function updateOrderStatus() {
        closeModal("orderDetailModal");
        const modal = document.getElementById("orderStatusModal");
        modal.classList.add("active");
      }

      async function saveOrderStatus() {
        if (!currentEditingOrderId) return;

        const status = document.getElementById("orderStatusSelect").value;
        const paymentStatus =
          document.getElementById("orderPaymentStatus").value;
        const trackingNumber = document.getElementById("orderTracking").value;

        try {
          const updateData = { status, paymentStatus };
          if (trackingNumber) {
            updateData.trackingNumber = trackingNumber;
          }

          const result = await api.updateOrder(
            currentEditingOrderId,
            updateData
          );
          if (result.success) {
            showNotification("Order updated successfully", "success");
            closeModal("orderStatusModal");
            loadOrders();
            loadDashboardData();
          } else {
            showNotification(result.message || "Error updating order", "error");
          }
        } catch (error) {
          console.error("Error updating order:", error);
          showNotification("Error updating order", "error");
        }
      }

      // Modal functions
      function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.classList.remove("active");
        }
      }

      // Close modals when clicking outside
      window.addEventListener("click", (e) => {
        if (e.target.classList.contains("modal")) {
          e.target.classList.remove("active");
        }
      });

      // Notification system
      function showNotification(message, type = "success") {
        const notification = document.createElement("div");
        notification.className = `alert ${type}`;
        notification.textContent = message;
        notification.style.position = "fixed";
        notification.style.top = "20px";
        notification.style.right = "20px";
        notification.style.zIndex = "10001";
        notification.style.minWidth = "300px";

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.style.opacity = "0";
          notification.style.transition = "opacity 0.3s";
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }

      async function loadDashboardData() {
        try {
          const stats = await api.getDashboardStats();
          if (stats.success && stats.data) {
            document.getElementById("totalProducts").textContent =
              stats.data.products.total || 0;
            document.getElementById("activeProducts").textContent =
              stats.data.products.active || 0;
            document.getElementById("newInquiries").textContent =
              stats.data.inquiries.new || 0;
            document.getElementById("pendingOrders").textContent =
              stats.data.orders.pending || 0;

            // Load recent inquiries
            if (stats.data.recentInquiries) {
              loadRecentInquiries(stats.data.recentInquiries);
            }

            // Load recent orders
            if (stats.data.recentOrders) {
              loadRecentOrders(stats.data.recentOrders);
            }
          }
        } catch (error) {
          console.error("Error loading dashboard:", error);
          showNotification("Error loading dashboard data", "error");
        }
      }

      function loadRecentInquiries(inquiries) {
        const container = document.getElementById("recentInquiriesList");
        if (!container) return;

        if (inquiries.length === 0) {
          container.innerHTML =
            '<div class="empty-state"><p>No recent inquiries</p></div>';
          return;
        }

        const table = document.createElement("table");
        table.innerHTML = `
          <thead>
            <tr>
              <th>Name</th>
              <th>Subject</th>
              <th>Status</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            ${inquiries
              .map(
                (inquiry) => `
              <tr style="cursor: pointer;" onclick="viewInquiry('${
                inquiry._id
              }')">
                <td>${inquiry.name}</td>
                <td>${inquiry.subject}</td>
                <td><span class="badge ${inquiry.status}">${
                  inquiry.status
                }</span></td>
                <td>${new Date(inquiry.createdAt).toLocaleDateString()}</td>
              </tr>
            `
              )
              .join("")}
          </tbody>
        `;
        container.innerHTML = "";
        container.appendChild(table);
      }

      function loadRecentOrders(orders) {
        const container = document.getElementById("recentOrdersList");
        if (!container) return;

        if (orders.length === 0) {
          container.innerHTML =
            '<div class="empty-state"><p>No recent orders</p></div>';
          return;
        }

        const table = document.createElement("table");
        table.innerHTML = `
          <thead>
            <tr>
              <th>Order #</th>
              <th>Customer</th>
              <th>Total</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            ${orders
              .map(
                (order) => `
              <tr style="cursor: pointer;" onclick="viewOrder('${order._id}')">
                <td>${order.orderNumber}</td>
                <td>${order.customer.name}</td>
                <td>KES ${order.total.toFixed(2)}</td>
                <td><span class="badge ${order.status}">${
                  order.status
                }</span></td>
              </tr>
            `
              )
              .join("")}
          </tbody>
        `;
        container.innerHTML = "";
        container.appendChild(table);
      }

      async function loadProducts() {
        try {
          const response = await api.getProducts({ limit: 50 });
          const tbody = document.getElementById("productsTableBody");
          tbody.innerHTML = "";

          if (response.success && response.data) {
            if (response.data.length === 0) {
              tbody.innerHTML =
                '<tr><td colspan="6" style="text-align: center; padding: 30px;">No products found. Click "Add Product" to create one.</td></tr>';
            } else {
              response.data.forEach((product) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                <td>${product.name}</td>
                <td>${product.category}</td>
                <td>${
                  product.price ? "KES " + product.price.toFixed(2) : "N/A"
                }</td>
                <td>${product.stock || 0}</td>
                <td>${product.active ? "Active" : "Inactive"}</td>
                <td>
                  <div class="action-buttons">
                    <button onclick="editProduct('${
                      product._id
                    }')" class="view-btn" title="Edit product">Edit</button>
                    <button onclick="deleteProduct('${
                      product._id
                    }')" class="delete-btn" title="Delete product">Delete</button>
                  </div>
                </td>
              `;
                tbody.appendChild(row);
              });
            }
          }
        } catch (error) {
          console.error("Error loading products:", error);
        }
      }

      async function loadInquiries() {
        try {
          const response = await api.getInquiries({ limit: 50 });
          const tbody = document.getElementById("inquiriesTableBody");
          tbody.innerHTML = "";

          if (response.success && response.data) {
            if (response.data.length === 0) {
              tbody.innerHTML =
                '<tr><td colspan="6" style="text-align: center; padding: 30px;">No inquiries found.</td></tr>';
            } else {
              response.data.forEach((inquiry) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                <td>${inquiry.name}</td>
                <td><a href="javascript:void(0)" onclick="openEmailClient('${escapeForOnClick(
                  inquiry.email
                )}', '${escapeForOnClick(
                  inquiry.subject || "Re: Your Inquiry"
                )}', '${escapeForOnClick(
                  (inquiry.message || "").substring(0, 500)
                )}')" style="color: #000; text-decoration: underline; cursor: pointer;" title="Click to respond via email">${
                  inquiry.email
                }</a></td>
                <td>${inquiry.subject}</td>
                <td><span class="badge ${inquiry.status}">${
                  inquiry.status
                }</span></td>
                <td>${new Date(inquiry.createdAt).toLocaleDateString()}</td>
                <td>
                  <div class="action-buttons">
                    <button onclick="viewInquiry('${
                      inquiry._id
                    }')" class="view-btn" title="View inquiry details">View</button>
                  </div>
                </td>
              `;
                tbody.appendChild(row);
              });
            }
          }
        } catch (error) {
          console.error("Error loading inquiries:", error);
        }
      }

      async function loadOrders() {
        try {
          const response = await api.getOrders({ limit: 50 });
          const tbody = document.getElementById("ordersTableBody");
          tbody.innerHTML = "";

          if (response.success && response.data) {
            if (response.data.length === 0) {
              tbody.innerHTML =
                '<tr><td colspan="6" style="text-align: center; padding: 30px;">No orders found.</td></tr>';
            } else {
              response.data.forEach((order) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                <td>${order.orderNumber}</td>
                <td>${order.customer.name}</td>
                <td>KES ${order.total.toFixed(2)}</td>
                <td><span class="badge ${order.status}">${
                  order.status
                }</span></td>
                <td>${new Date(order.createdAt).toLocaleDateString()}</td>
                <td>
                  <div class="action-buttons">
                    <button onclick="viewOrder('${
                      order._id
                    }')" class="view-btn" title="View order details">View</button>
                  </div>
                </td>
              `;
                tbody.appendChild(row);
              });
            }
          }
        } catch (error) {
          console.error("Error loading orders:", error);
        }
      }

      // Function to open email client (Gmail preferred, fallback to mailto)
      function openEmailClient(email, subject, body) {
        if (!email) return;

        // Clean and encode parameters for URL
        const encodedEmail = encodeURIComponent(email);
        const encodedSubject = encodeURIComponent(
          subject || "Re: Your Inquiry"
        );
        // Clean body - remove HTML tags, limit length, and encode
        let cleanBody = (body || "").toString();
        cleanBody = cleanBody.replace(/<[^>]*>/g, ""); // Remove HTML tags
        cleanBody = cleanBody.substring(0, 1000); // Limit length
        const encodedBody = encodeURIComponent(cleanBody);

        // Try Gmail compose URL first
        const gmailUrl = `https://mail.google.com/mail/?view=cm&to=${encodedEmail}&su=${encodedSubject}&body=${encodedBody}`;

        // Also prepare fallback mailto link
        const mailtoUrl = `mailto:${encodedEmail}?subject=${encodedSubject}&body=${encodedBody}`;

        // Try to open Gmail in new tab/window
        // If user is not logged into Gmail, it will prompt them or use default email client
        try {
          const gmailWindow = window.open(gmailUrl, "_blank");
          // If popup was blocked, fallback to mailto
          if (!gmailWindow) {
            window.location.href = mailtoUrl;
          }
        } catch (error) {
          // Fallback to mailto if window.open fails
          window.location.href = mailtoUrl;
        }
      }

      // Helper function to safely escape strings for onclick handlers
      function escapeForOnClick(str) {
        if (!str) return "";
        return str
          .replace(/\\/g, "\\\\")
          .replace(/'/g, "\\'")
          .replace(/"/g, '\\"')
          .replace(/\n/g, "\\n")
          .replace(/\r/g, "\\r");
      }

      // Format message for display - preserve line breaks and format bullet points
      function formatMessage(message) {
        if (!message) return "";

        // Escape HTML to prevent XSS
        let formatted = String(message)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");

        // Split into lines to process each line separately
        const lines = formatted.split(/\r?\n/);
        const formattedLines = lines.map((line, index) => {
          // Trim the line but preserve indentation for structure
          const trimmed = line.trim();

          // Detect bullet points (, -, *, etc.)
          const bulletMatch = trimmed.match(/^([\-\*])\s+(.+)$/);
          if (bulletMatch) {
            return `&nbsp;&nbsp;${bulletMatch[1]} ${bulletMatch[2]}`;
          }

          // Detect dash-separated items (e.g., "Product Name  Quantity: 50")
          const dashMatch = trimmed.match(/^(.+?)\s*[-]\s*(.+)$/);
          if (dashMatch) {
            return `<strong>${dashMatch[1]}</strong>  ${dashMatch[2]}`;
          }

          // Return original line if it's not empty, otherwise preserve spacing
          return trimmed || (index < lines.length - 1 ? "&nbsp;" : "");
        });

        // Join lines with <br> and preserve multiple line breaks
        return formattedLines.join("<br>");
      }

      // Data Management Functions
      async function loadDataManagement() {
        try {
          // Get actual database stats from backend
          const dbStats = await api.getDatabaseStats();

          if (dbStats.success && dbStats.data) {
            const data = dbStats.data;

            // Use actual database sizes - use storageSizeMB which matches MongoDB Atlas
            const totalSizeMB =
              data.database.storageSizeMB || data.database.totalSizeMB || 0;
            const limitMB = data.limitMB || 512;

            // Recalculate usage percent with actual storageSize
            const usagePercent =
              totalSizeMB > 0 ? (totalSizeMB / limitMB) * 100 : 0;

            const totalRecords = data.totalRecords || 0;
            const totalInquiries = data.collections.inquiries?.count || 0;
            const totalOrders = data.collections.orders?.count || 0;
            const totalProducts = data.collections.products?.count || 0;

            // Update UI with actual database stats
            document.getElementById(
              "dbUsage"
            ).textContent = `${totalSizeMB.toFixed(2)} MB / ${limitMB} MB`;
            document.getElementById("totalRecords").textContent =
              totalRecords.toLocaleString();
            document.getElementById("inquiriesCount").textContent =
              totalInquiries.toLocaleString();
            document.getElementById("ordersCount").textContent =
              totalOrders.toLocaleString();

            // Show warning if above 80%
            const warningDiv = document.getElementById("dbUsageWarning");
            if (usagePercent >= 80) {
              warningDiv.style.display = "block";
              warningDiv.innerHTML = `<strong>Warning:</strong> Your database is at ${usagePercent.toFixed(
                1
              )}% capacity (${totalSizeMB.toFixed(
                2
              )} MB / ${limitMB} MB). Consider deleting old data to free up space.`;
              warningDiv.className = "alert error";
            } else if (usagePercent >= 60) {
              warningDiv.style.display = "block";
              warningDiv.innerHTML = `<strong>Notice:</strong> Your database is at ${usagePercent.toFixed(
                1
              )}% capacity (${totalSizeMB.toFixed(2)} MB / ${limitMB} MB).`;
              warningDiv.className = "alert";
            } else {
              warningDiv.style.display = "none";
            }
          } else {
            // Fallback to estimated method if backend stats fail
            console.warn("Could not get database stats, using estimates");
            showNotification("Using estimated database size", "error");
            loadDataManagementFallback();
          }
        } catch (error) {
          console.error("Error loading data management stats:", error);
          showNotification(
            "Error loading database statistics. Using estimates.",
            "error"
          );
          loadDataManagementFallback();
        }
      }

      // Fallback method using estimates
      async function loadDataManagementFallback() {
        try {
          const [inquiriesRes, ordersRes, productsRes, dashboardRes] =
            await Promise.all([
              api.getInquiries({ limit: 1 }),
              api.getOrders({ limit: 1 }),
              api.getProducts({ limit: 1 }),
              api.getDashboardStats(),
            ]);

          let totalInquiries = 0;
          let totalOrders = 0;
          let totalProducts = 0;

          if (dashboardRes.success && dashboardRes.data) {
            totalInquiries = dashboardRes.data.inquiries?.total || 0;
            totalOrders = dashboardRes.data.orders?.total || 0;
            totalProducts = dashboardRes.data.products?.total || 0;
          }

          const totalRecords = totalInquiries + totalOrders + totalProducts;
          const estimatedSizeBytes =
            totalInquiries * 500 + totalOrders * 1024 + totalProducts * 2048;
          const estimatedSizeMB = estimatedSizeBytes / (1024 * 1024);
          const limitMB = 512;
          const usagePercent = (estimatedSizeMB / limitMB) * 100;

          document.getElementById(
            "dbUsage"
          ).textContent = `${estimatedSizeMB.toFixed(
            2
          )} MB / ${limitMB} MB (Estimated)`;
          document.getElementById("totalRecords").textContent =
            totalRecords.toLocaleString();
          document.getElementById("inquiriesCount").textContent =
            totalInquiries.toLocaleString();
          document.getElementById("ordersCount").textContent =
            totalOrders.toLocaleString();
        } catch (error) {
          console.error("Error in fallback:", error);
        }
      }

      // Download Data Functions
      async function downloadData(type, format) {
        try {
          showNotification(`Preparing ${type} download...`, "success");

          let data = [];
          let filename = "";

          // Fetch data based on type
          if (type === "inquiries") {
            const response = await api.getInquiries({ limit: 10000 });
            if (response.success && response.data) {
              data = response.data;
              filename = `quote_requests_${
                new Date().toISOString().split("T")[0]
              }`;
            } else {
              showNotification("Failed to fetch quote requests data", "error");
              return;
            }
          } else if (type === "orders") {
            const response = await api.getOrders({ limit: 10000 });
            if (response.success && response.data) {
              data = response.data;
              filename = `orders_${new Date().toISOString().split("T")[0]}`;
            } else {
              showNotification("Failed to fetch orders data", "error");
              return;
            }
          } else if (type === "products") {
            const response = await api.getProducts({ limit: 10000 });
            if (response.success && response.data) {
              data = response.data;
              filename = `products_${new Date().toISOString().split("T")[0]}`;
            } else {
              showNotification("Failed to fetch products data", "error");
              return;
            }
          }

          if (data.length === 0) {
            showNotification("No data to download", "error");
            return;
          }

          // Download based on format
          if (format === "pdf") {
            try {
              downloadPDF(data, filename, type);
              showNotification(
                `Downloaded ${data.length} ${type} as PDF`,
                "success"
              );
            } catch (pdfError) {
              console.error("PDF generation error:", pdfError);
              showNotification(
                "Error generating PDF. Please try CSV format.",
                "error"
              );
            }
          } else if (format === "csv") {
            try {
              downloadCSV(data, filename);
              showNotification(
                `Downloaded ${data.length} ${type} as CSV`,
                "success"
              );
            } catch (csvError) {
              console.error("CSV generation error:", csvError);
              showNotification("Error generating CSV", "error");
            }
          }
        } catch (error) {
          console.error("Error downloading data:", error);
          showNotification(`Error downloading data: ${error.message}`, "error");
        }
      }

      function downloadPDF(data, filename, type) {
        // Check if jsPDF is loaded
        if (
          typeof window.jspdf === "undefined" &&
          typeof window.jsPDF === "undefined"
        ) {
          showNotification(
            "PDF library not loaded. Please refresh the page and try again.",
            "error"
          );
          console.error(
            "jsPDF library not found. Make sure the CDN scripts are loaded."
          );
          return;
        }

        // Try to get jsPDF - check both possible locations
        let jsPDF;
        if (typeof window.jspdf !== "undefined") {
          jsPDF = window.jspdf.jsPDF;
        } else if (typeof window.jsPDF !== "undefined") {
          jsPDF = window.jsPDF;
        } else {
          showNotification("PDF library not available", "error");
          return;
        }

        const doc = new jsPDF();

        // Title
        doc.setFontSize(16);
        doc.text(
          `${type.charAt(0).toUpperCase() + type.slice(1)} Report`,
          14,
          15
        );
        doc.setFontSize(10);
        doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 22);
        doc.text(`Total Records: ${data.length}`, 14, 27);

        let yPosition = 35;
        const pageHeight = doc.internal.pageSize.height;
        const margin = 14;

        if (data.length === 0) {
          doc.text("No data available", margin, yPosition);
          doc.save(`${filename}.pdf`);
          return;
        }

        // Get headers from first object
        const headers = Object.keys(data[0]);

        // Format data for table
        const tableData = data.map((row) => {
          return headers.map((header) => {
            let value = row[header];
            if (value === null || value === undefined) return "";
            if (typeof value === "object") {
              value = JSON.stringify(value);
            }
            // Limit length for PDF readability
            value = String(value).substring(0, 50);
            return value;
          });
        });

        // Create table using autoTable
        // Check if autoTable is available
        if (typeof doc.autoTable === "function") {
          doc.autoTable({
            head: [headers],
            body: tableData,
            startY: yPosition,
            margin: { top: yPosition, left: margin, right: margin },
            styles: { fontSize: 8, cellPadding: 2 },
            headStyles: {
              fillColor: [0, 0, 0],
              textColor: 255,
              fontStyle: "bold",
            },
            alternateRowStyles: { fillColor: [245, 245, 245] },
            columnStyles: {
              0: { cellWidth: 30 },
              1: { cellWidth: 40 },
              2: { cellWidth: 50 },
              3: { cellWidth: 40 },
              4: { cellWidth: 30 },
            },
            didDrawPage: (pageData) => {
              // Add page number
              doc.setFontSize(10);
              doc.text(
                `Page ${pageData.pageNumber}`,
                doc.internal.pageSize.width / 2,
                doc.internal.pageSize.height - 10,
                { align: "center" }
              );
            },
          });
        } else {
          // Fallback: simple text table if autoTable not available
          doc.setFontSize(8);
          let currentY = yPosition;
          headers.forEach((header, index) => {
            doc.text(`${header}:`, margin, currentY);
            currentY += 6;
          });
        }

        // Save PDF
        try {
          doc.save(`${filename}.pdf`);
        } catch (saveError) {
          console.error("Error saving PDF:", saveError);
          showNotification("Error saving PDF file", "error");
        }
      }

      function downloadCSV(data, filename) {
        if (data.length === 0) return;

        // Get headers from first object
        const headers = Object.keys(data[0]);

        // Create CSV content
        let csv = headers.join(",") + "\n";

        data.forEach((row) => {
          const values = headers.map((header) => {
            let value = row[header];
            // Handle nested objects
            if (typeof value === "object" && value !== null) {
              value = JSON.stringify(value);
            }
            // Escape quotes and wrap in quotes if contains comma
            value = String(value || "").replace(/"/g, '""');
            if (
              value.includes(",") ||
              value.includes("\n") ||
              value.includes('"')
            ) {
              value = `"${value}"`;
            }
            return value;
          });
          csv += values.join(",") + "\n";
        });

        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${filename}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Bulk Delete Functions
      async function deleteInquiriesBulk() {
        const days =
          parseInt(document.getElementById("inquiryDeleteDate").value) || 90;
        const statusFilter = document.getElementById(
          "inquiryDeleteStatus"
        ).value;

        const confirmMessage = `Are you sure you want to delete inquiries older than ${days} days${
          statusFilter !== "all" ? ` with status: ${statusFilter}` : ""
        }?\n\nThis action cannot be undone. Make sure you have downloaded a backup first!`;

        const confirmed = await showConfirmation(
          "Delete Quote Requests",
          confirmMessage
        );

        if (!confirmed) {
          return;
        }

        try {
          showNotification("Deleting inquiries...", "success");

          // Get all inquiries
          const response = await api.getInquiries({ limit: 10000 });
          if (!response.success || !response.data) {
            showNotification("Error fetching inquiries", "error");
            return;
          }

          const cutoffDate = new Date();
          cutoffDate.setDate(cutoffDate.getDate() - days);

          let deleted = 0;
          let failed = 0;

          for (const inquiry of response.data) {
            const inquiryDate = new Date(inquiry.createdAt);
            const statusMatch =
              statusFilter === "all" ||
              (statusFilter === "closed,responded" &&
                (inquiry.status === "closed" ||
                  inquiry.status === "responded")) ||
              inquiry.status === statusFilter;

            if (inquiryDate < cutoffDate && statusMatch) {
              try {
                const deleteRes = await api.deleteInquiry(inquiry._id);
                if (deleteRes.success) {
                  deleted++;
                } else {
                  failed++;
                }
              } catch (error) {
                failed++;
                console.error("Error deleting inquiry:", inquiry._id, error);
              }
            }
          }

          showNotification(
            `Deleted ${deleted} inquiries${
              failed > 0 ? `, ${failed} failed` : ""
            }`,
            deleted > 0 ? "success" : "error"
          );
          loadDataManagement();
          loadInquiries();
          loadDashboardData();
        } catch (error) {
          console.error("Error deleting inquiries:", error);
          showNotification("Error deleting inquiries", "error");
        }
      }

      async function deleteOrdersBulk() {
        const days =
          parseInt(document.getElementById("orderDeleteDate").value) || 180;
        const statusFilter = document.getElementById("orderDeleteStatus").value;

        const confirmMessage = `Are you sure you want to delete orders older than ${days} days${
          statusFilter !== "all" ? ` with status: ${statusFilter}` : ""
        }?\n\nThis action cannot be undone. Make sure you have downloaded a backup first!`;

        const confirmed = await showConfirmation(
          "Delete Orders",
          confirmMessage
        );

        if (!confirmed) {
          return;
        }

        try {
          showNotification("Deleting orders...", "success");

          // Get all orders
          const response = await api.getOrders({ limit: 10000 });
          if (!response.success || !response.data) {
            showNotification("Error fetching orders", "error");
            return;
          }

          const cutoffDate = new Date();
          cutoffDate.setDate(cutoffDate.getDate() - days);

          let deleted = 0;
          let failed = 0;

          for (const order of response.data) {
            const orderDate = new Date(order.createdAt);
            const statusMatch =
              statusFilter === "all" ||
              (statusFilter === "delivered,cancelled" &&
                (order.status === "delivered" ||
                  order.status === "cancelled")) ||
              order.status === statusFilter;

            if (orderDate < cutoffDate && statusMatch) {
              try {
                const deleteRes = await api.deleteOrder(order._id);
                if (deleteRes.success) {
                  deleted++;
                } else {
                  failed++;
                }
              } catch (error) {
                failed++;
                console.error("Error deleting order:", order._id, error);
              }
            }
          }

          showNotification(
            `Deleted ${deleted} orders${
              failed > 0 ? `, ${failed} failed` : ""
            }`,
            deleted > 0 ? "success" : "error"
          );
          loadDataManagement();
          loadOrders();
          loadDashboardData();
        } catch (error) {
          console.error("Error deleting orders:", error);
          showNotification("Error deleting orders", "error");
        }
      }

      // Custom Confirmation Function
      function showConfirmation(title, message) {
        return new Promise((resolve) => {
          const modal = document.getElementById("confirmationModal");
          const titleEl = document.getElementById("confirmationTitle");
          const messageEl = document.getElementById("confirmationMessage");
          const confirmBtn = document.getElementById("confirmationConfirm");
          const cancelBtn = document.getElementById("confirmationCancel");

          titleEl.textContent = title;
          messageEl.textContent = message;

          modal.classList.add("active");

          const cleanup = () => {
            modal.classList.remove("active");
            confirmBtn.onclick = null;
            cancelBtn.onclick = null;
            document.removeEventListener("keydown", escapeHandler);
          };

          const escapeHandler = (e) => {
            if (e.key === "Escape") {
              cleanup();
              resolve(false);
            }
          };

          confirmBtn.onclick = () => {
            cleanup();
            resolve(true);
          };

          cancelBtn.onclick = () => {
            cleanup();
            resolve(false);
          };

          document.addEventListener("keydown", escapeHandler);

          // Focus confirm button by default
          setTimeout(() => confirmBtn.focus(), 100);
        });
      }

      // Custom Prompt Function
      function showPrompt(title, message, defaultValue = "") {
        return new Promise((resolve) => {
          const modal = document.getElementById("promptModal");
          const titleEl = document.getElementById("promptTitle");
          const messageEl = document.getElementById("promptMessage");
          const inputEl = document.getElementById("promptInput");
          const submitBtn = document.getElementById("promptSubmit");
          const cancelBtn = document.getElementById("promptCancel");

          titleEl.textContent = title;
          messageEl.textContent = message;
          inputEl.value = defaultValue;

          modal.classList.add("active");
          inputEl.focus();
          inputEl.select();

          const cleanup = () => {
            modal.classList.remove("active");
            inputEl.value = "";
            submitBtn.onclick = null;
            cancelBtn.onclick = null;
            inputEl.onkeydown = null;
            document.removeEventListener("keydown", escapeHandler);
          };

          const escapeHandler = (e) => {
            if (e.key === "Escape") {
              cleanup();
              resolve(null);
            }
          };

          const submit = () => {
            const value = inputEl.value;
            cleanup();
            resolve(value);
          };

          submitBtn.onclick = submit;

          cancelBtn.onclick = () => {
            cleanup();
            resolve(null);
          };

          inputEl.onkeydown = (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              submit();
            }
          };

          document.addEventListener("keydown", escapeHandler);
        });
      }

      // Clear All Data Function
      async function clearAllData() {
        // First warning - must download first
        const firstWarning = await showConfirmation(
          "CRITICAL WARNING",
          "You are about to DELETE ALL DATA from the database.\n\n" +
            "This includes:\n" +
            "- All Quote Requests\n" +
            "- All Orders\n" +
            "- All Products\n\n" +
            "This action CANNOT be undone!\n\n" +
            "Have you downloaded all your data?\n\n" +
            "Click Confirm if you have backed up your data and want to proceed.\n" +
            "Click Cancel to go back and download your data first."
        );

        if (!firstWarning) {
          showNotification(
            "Clear database cancelled. Please download your data first.",
            "error"
          );
          return;
        }

        // Second confirmation
        const secondWarning = await showConfirmation(
          "FINAL CONFIRMATION",
          "Are you ABSOLUTELY SURE you want to delete ALL data?\n\n" +
            "This will:\n" +
            "- Delete all Quote Requests\n" +
            "- Delete all Orders\n" +
            "- Delete all Products (keep admin users)\n" +
            "- Reset database to 0 MB\n\n" +
            "Type 'CLEAR ALL DATA' in the next dialog to proceed."
        );

        if (!secondWarning) {
          showNotification("Clear database cancelled.", "error");
          return;
        }

        // Third confirmation with typing required
        const confirmText = await showPrompt(
          "TYPE CONFIRMATION",
          "Type 'CLEAR ALL DATA' (in capital letters) to confirm:\n\n" +
            "This is your last chance to cancel.",
          ""
        );

        if (confirmText !== "CLEAR ALL DATA") {
          showNotification(
            confirmText
              ? "Confirmation text did not match. Clear database cancelled."
              : "Clear database cancelled.",
            "error"
          );
          return;
        }

        try {
          showNotification(
            "Clearing all data... This may take a moment.",
            "success"
          );

          // Call backend to clear all data
          const response = await api.clearAllData();

          if (response.success && response.data) {
            const data = response.data;

            // Show detailed success message
            const message =
              `All data cleared successfully!\n\n` +
              `Deleted: ${data.deleted.inquiries} inquiries, ${data.deleted.orders} orders, ${data.deleted.products} products\n` +
              `Verified: ${data.verified.inquiriesRemaining} inquiries, ${data.verified.ordersRemaining} orders, ${data.verified.productsRemaining} products remaining\n` +
              `Database size: ${data.after.storageSizeMB.toFixed(
                2
              )} MB (freed ${data.after.freedMB.toFixed(2)} MB)`;

            showNotification(message, "success");

            // Wait a moment then reload all sections
            setTimeout(() => {
              loadDataManagement();
              loadInquiries();
              loadOrders();
              loadProducts();
              loadDashboardData();
            }, 500);
          } else {
            showNotification(
              response.message || "Error clearing database",
              "error"
            );
          }
        } catch (error) {
          console.error("Error clearing database:", error);
          showNotification(
            `Error clearing database: ${error.message}`,
            "error"
          );
        }
      }

      // Wait for page to load and api to be available
      document.addEventListener("DOMContentLoaded", function () {
        // Make sure api is defined
        if (typeof api === "undefined") {
          console.error("API client not loaded. Please check js/api.js");
          document.getElementById("loginError").textContent =
            "API client not loaded. Please check console.";
          document.getElementById("loginError").style.display = "block";
          return;
        }

        // Check if user is logged in
        if (api.token) {
          showDashboard();
        }

        // Login form handler
        document
          .getElementById("loginForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            const errorDiv = document.getElementById("loginError");

            try {
              const response = await api.login({ email, password });
              if (response.success) {
                showDashboard();
              } else {
                errorDiv.textContent = response.message || "Login failed";
                errorDiv.style.display = "block";
              }
            } catch (error) {
              errorDiv.textContent = error.message || "Login failed";
              errorDiv.style.display = "block";
            }
          });
      }); // End DOMContentLoaded
    </script>
  </body>
</html>
